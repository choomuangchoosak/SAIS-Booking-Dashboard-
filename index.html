<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SAIS schedule digital booking</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root { 
      --schindler-red: #D0021B; 
      --date-col-width: 45px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
      --insp-col-width: 85px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å */
    }
    
    body { font-family: 'Sarabun', sans-serif; background-color: #fff; margin: 0; padding: 0; overflow: hidden; }

    /* Navbar */
    .navbar { background-color: white !important; border-bottom: 2.5px solid var(--schindler-red); height: 48px; padding: 0 10px; z-index: 1060; }
    .navbar-brand { color: var(--schindler-red) !important; font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Table Container */
    .board-container { position: absolute; top: 48px; left: 0; right: 0; bottom: 0; overflow: auto; background: white; -webkit-overflow-scrolling: touch; }
    .table-main { border-collapse: separate; border-spacing: 0; width: max-content; min-width: 100%; table-layout: fixed; }
    
    /* Headers */
    .table-main th { 
      background-color: var(--schindler-red); color: white; text-align: center; padding: 8px 2px; font-weight: 700; font-size: 9px;
      position: sticky; top: 0; z-index: 20; border: 0.5px solid #b00015; width: var(--insp-col-width);
      white-space: normal; word-break: break-word; line-height: 1;
    }

    .table-main th.corner-header {
      left: 0; z-index: 40; background-color: #222 !important;
      width: var(--date-col-width) !important; min-width: var(--date-col-width) !important; max-width: var(--date-col-width) !important;
      font-size: 9px; line-height: 1; border: 1px solid #111;
    }

    .col-date { 
      position: sticky; left: 0; z-index: 10; background-color: #f0f0f0 !important;
      width: var(--date-col-width) !important; min-width: var(--date-col-width) !important; max-width: var(--date-col-width) !important;
      text-align: center; font-weight: 800; font-size: 14px; color: #333;
      border-right: 2px solid #888 !important; border-bottom: 0.5px solid #ddd !important;
      vertical-align: middle;
    }
    
    .table-main td { border: 0.5px solid #eee; vertical-align: top; padding: 2px; height: 75px; width: var(--insp-col-width); overflow: hidden; }
    .sunday-row td { background-color: #fff9f9; }
    .sunday-row td.col-date { background-color: #ffeded !important; }

    /* Card Design - ‡∏ö‡∏µ‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å */
    .job-card { 
      background: white; border: 1px solid #ddd; border-left: 3px solid #999; 
      padding: 3px 4px; margin-bottom: 3px; border-radius: 3px; cursor: pointer; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); width: 100%;
    }
    .job-card.bkk { border-left-color: #222; }
    .job-card.upc { border-left-color: #E91E63; background: #fff2f7; }
    .job-card.re { border-left-color: #FFC107; background: #fffef2; }
    
    .job-card .eq-line { font-size: 9px; font-weight: 800; color: #000; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.1; }
    .job-card .site-line { font-size: 8px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; line-height: 1; margin-top: 1px; }

    /* Modals & UI */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .menu-item { height: 80px; border: 1px solid #ddd; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white; font-weight: bold; cursor: pointer; font-size: 12px; }
    .menu-item i { font-size: 1.5rem; margin-bottom: 4px; color: var(--schindler-red); }
    .map-container { position: relative; padding-bottom: 60%; height: 0; overflow: hidden; border-radius: 8px; border: 1px solid #ddd; margin-top: 10px; }
    .map-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
  </style>
</head>
<body>

<div id="globalLoading" class="loading-overlay">
  <div class="spinner-border text-danger" style="width: 2rem; height: 2rem;"></div>
  <div class="mt-3 fw-bold text-secondary small">FETCHING...</div>
</div>

<nav class="navbar fixed-top d-flex justify-content-between shadow-sm">
    <span class="navbar-brand">SAIS SCHEDULE <span style="font-weight:300;">DIGITAL BOOKING</span></span>
    <div>
      <span id="publicArea"><button class="btn btn-sm btn-outline-dark py-0" style="font-size:10px;" onclick="openLoginModal()">Login</button></span>
      <span id="privateArea" style="display:none;">
          <button class="btn btn-sm btn-schindler me-1 py-0" style="font-size:10px;" onclick="openMenuModal()">Menu</button>
          <button class="btn btn-sm btn-light py-0" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></button>
      </span>
    </div>
</nav>

<div class="board-container">
  <table class="table-main" id="mainTable">
    <thead><tr id="headerRow"></tr></thead>
    <tbody id="boardBody"></tbody>
  </table>
</div>

<!-- ================= MODALS ================= -->
<!-- Login -->
<div class="modal fade" id="authModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content">
  <div id="viewLogin"><div class="modal-header bg-dark text-white p-2"><h6 class="modal-title">Login</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-3"><input type="text" id="loginUser" class="form-control mb-2 form-control-sm" placeholder="Username"><input type="password" id="loginPass" class="form-control mb-3 form-control-sm" placeholder="Password"><button class="btn btn-schindler btn-sm w-100" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button><div class="text-center mt-3 small"><a href="#" onclick="toggleAuthView('register')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a></div></div></div>
  <div id="viewRegister" style="display:none;"><div class="modal-header bg-danger text-white p-2"><h6 class="modal-title">Register</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-3"><form id="regForm"><input type="text" id="regUser" class="form-control mb-1 form-control-sm" placeholder="Username" required><input type="password" id="regPass" class="form-control mb-1 form-control-sm" placeholder="Password" required><input type="text" id="regName" class="form-control mb-1 form-control-sm" placeholder="Full Name" required><input type="text" id="regPE" class="form-control mb-1 form-control-sm" placeholder="PE Code" required><input type="text" id="regDept" class="form-control mb-1 form-control-sm" placeholder="Dept" required><input type="text" id="regPhone" class="form-control mb-1 form-control-sm" placeholder="Phone" required><input type="email" id="regEmail" class="form-control mb-2 form-control-sm" placeholder="Email (@schindler.com)" required><button type="submit" class="btn btn-schindler btn-sm w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></form><div class="text-center mt-2 small"><a href="#" onclick="toggleAuthView('login')">Back</a></div></div></div>
</div></div></div>

<!-- Menu -->
<div class="modal fade" id="menuModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header p-2"><h6 class="modal-title fw-bold text-danger">Main Menu</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-3"><div class="menu-grid">
  <div class="menu-item" onclick="openBookingModal()"><i class="fas fa-plus-circle"></i>‡∏à‡∏≠‡∏á‡∏á‡∏≤‡∏ô</div><div class="menu-item" onclick="openHistoryModal()"><i class="fas fa-history"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div><div class="menu-item" onclick="openManualModal()"><i class="fas fa-book-open"></i>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</div><div class="menu-item" id="btnAdminMenu" style="display:none;" onclick="openAdminPanel()"><i class="fas fa-users-cog"></i>Admin</div>
</div></div></div></div></div>

<!-- Booking -->
<div class="modal fade" id="bookingModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-dark text-white p-2"><h6>‡∏•‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏£‡∏ß‡∏à</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-3"><form id="bookingForm" class="needs-validation" novalidate><input type="hidden" id="formRowId">
  <div class="mb-2"><label class="fw-bold" style="font-size:11px;">Site Name *</label><input type="text" class="form-control form-control-sm" id="site" required></div>
  <div class="row mb-2"><div class="col-6"><label class="fw-bold" style="font-size:11px;">Equip No. *</label><input type="text" class="form-control form-control-sm" id="equipNo" required pattern="[0-9]+"></div><div class="col-6"><label class="fw-bold" style="font-size:11px;">Unit No.</label><input type="text" class="form-control form-control-sm" id="unitNo"></div></div>
  <div class="row mb-2"><div class="col-4"><label class="fw-bold" style="font-size:11px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à *</label><input type="date" class="form-control form-control-sm" id="date" required onchange="validateDate(this)"></div><div class="col-4"><label class="fw-bold" style="font-size:11px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select class="form-select form-select-sm" id="type"><option>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û/‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•</option><option>‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option><option>Re-inspection</option></select></div><div class="col-4"><label class="fw-bold" style="font-size:11px;">Inspector</label><select class="form-select form-select-sm" id="inspectorName" required></select></div></div>
  <div class="row mb-2"><div class="col-6"><label class="fw-bold" style="font-size:11px;">Foreman</label><input type="text" class="form-control form-control-sm" id="foreman" required></div><div class="col-6"><label class="fw-bold" style="font-size:11px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" class="form-control form-control-sm" id="tel" required></div></div>
  <div class="mb-1"><label class="fw-bold" style="font-size:11px;">Map Link</label><input type="text" class="form-control form-control-sm" id="map" placeholder="https://..."></div>
</form></div><div class="modal-footer p-2"><button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button><button type="button" class="btn btn-sm btn-schindler" onclick="submitBooking()">SAVE</button></div></div></div></div>

<!-- Detail -->
<div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-light p-2"><h6 class="modal-title fw-bold text-danger" id="detailSite">Site</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-3" id="detailModalBody"></div><div class="px-3 pb-3" id="actionArea"></div><div class="modal-footer bg-light p-2"><small class="text-muted me-auto" id="detailCreatedBy" style="font-size:10px;"></small><div id="manageButtons"></div></div></div></div></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // üî¥ API URL ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const API_URL = "https://script.google.com/macros/s/AKfycbzA12AZgUoP4Ayw0NB4KLwd0a7htVC8mpoGkeWpyZV8fIrBoMRrwf8JF5We9IoNdnbi/exec";

  let currentUser = null;
  let allJobs = [];
  let inspectorList = [];
  let currentJobId = null;

  window.onload = loadData;

  async function loadData() {
    showLoading(true, "FETCHING...");
    try {
      const res = await fetch(`${API_URL}?action=getData`);
      const data = await res.json();
      if(data.success) {
        renderBoard(data);
        checkNewJobsPopup(data.jobs); // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
      } else { Swal.fire("Backend Error", data.message, "error"); }
    } catch(e) { Swal.fire("Error", "Server Connection Failed", "error"); }
    showLoading(false);
  }

  // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Pop-up ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ---
  function checkNewJobsPopup(jobs) {
    const now = new Date().getTime();
    const oneDay = 24 * 60 * 60 * 1000;
    const newJobs = jobs.filter(j => (now - j.createdTime) < oneDay);

    if (newJobs.length > 0) {
      let list = '<div class="text-start small mt-2" style="font-size:11px;">';
      newJobs.forEach(j => {
        list += `<div class="mb-2 border-bottom pb-1 text-dark">üìç <b>${j.site}</b><br>‚öôÔ∏è Equip: ${j.equipNo} | üë∑ ${j.inspectorName}</div>`;
      });
      list += '</div>';

      Swal.fire({
        title: `üì¢ ‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (${newJobs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`,
        html: `‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô 24 ‡∏ä‡∏°. ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:${list}`,
        icon: 'info',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        confirmButtonColor: '#D0021B'
      });
    }
  }

  function renderBoard(data) {
    allJobs = data.jobs; 
    inspectorList = data.inspectors; 

    const now = new Date();
    const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
    const monthStr = months[now.getMonth()];
    const yearStr = now.getFullYear();

    // 1. Header (Dynamic & Compact)
    const header = document.getElementById('headerRow');
    header.innerHTML = `<th class="corner-header">${monthStr}<br>${yearStr}</th>`;
    inspectorList.forEach(n => {
        const th = document.createElement('th'); th.innerText = n.toUpperCase(); header.appendChild(th);
    });

    const sel = document.getElementById('inspectorName');
    if(sel) sel.innerHTML = inspectorList.map(n => `<option value="${n}">${n}</option>`).join('');

    // 2. Body
    const tbody = document.getElementById('boardBody');
    tbody.innerHTML = '';
    const daysCount = new Date(yearStr, now.getMonth() + 1, 0).getDate();

    for(let d = 1; d <= daysCount; d++) {
        const dateObj = new Date(yearStr, now.getMonth(), d);
        const iso = dateObj.toISOString().split('T')[0];
        const tr = document.createElement('tr');
        if(dateObj.getDay() === 0) tr.className = 'sunday-row';

        const tdDate = document.createElement('td'); tdDate.className = 'col-date'; tdDate.innerText = d;
        tr.appendChild(tdDate);

        inspectorList.forEach(name => {
            const tdJob = document.createElement('td');
            const filtered = allJobs.filter(j => j.date === iso && j.inspectorName === name);
            filtered.forEach(j => {
                const cls = j.type==='upcountry'?'upc':(j.type==='reinspect'?'re':'bkk');
                const card = document.createElement('div');
                card.className = `job-card ${cls}`;
                card.onclick = () => openDetail(j.rowId);
                card.innerHTML = `<span class="eq-line">${j.equipNo}</span><span class="site-line">${j.site}</span>`;
                tdJob.appendChild(card);
            });
            tr.appendChild(tdJob);
        });
        tbody.appendChild(tr);
    }
  }

  async function callAPI(action, data = null) {
    try {
      const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, data, user: currentUser ? currentUser.username : null }) });
      return await res.json();
    } catch (e) { return { success: false, message: "Lost Connection" }; }
  }

  async function handleLogin() {
    const u = document.getElementById('loginUser').value, p = document.getElementById('loginPass').value;
    showLoading(true); const res = await callAPI('login', { username: u, password: p });
    showLoading(false);
    if(res.success) { currentUser = res.user; updateUI(); bootstrap.Modal.getInstance(document.getElementById('authModal')).hide(); openMenuModal(); }
    else Swal.fire("Error", res.message, "error");
  }

  function updateUI() {
    if(currentUser) {
      document.getElementById('privateArea').style.display = 'inline-block'; document.getElementById('publicArea').style.display = 'none';
      document.getElementById('userSection').innerHTML = `<small class="badge bg-light text-dark border">${currentUser.fullname}</small>`;
    } else {
      document.getElementById('privateArea').style.display = 'none'; document.getElementById('publicArea').style.display = 'inline-block';
    }
  }

  function openDetail(rowId) {
    const j = allJobs.find(x => x.rowId === rowId); if(!j) return;
    currentJobId = rowId;
    document.getElementById('detailSite').innerText = j.site;
    document.getElementById('detailCreatedBy').innerText = `Created by: ${j.createdBy || '-'}`;
    let mapHTML = j.map && j.map.length > 5 ? `<div class="mt-2"><div class="map-container"><iframe src="https://maps.google.com/maps?q=${encodeURIComponent(j.map)}&t=&z=15&ie=UTF8&iwloc=&output=embed"></iframe></div></div>` : "";
    document.getElementById('detailModalBody').innerHTML = `<div class="row g-2 small" style="font-size:12px;"><div class="col-6"><strong>Insp:</strong><br>${j.inspectorName}</div><div class="col-6"><strong>Equip:</strong><br>${j.equipNo}</div><div class="col-6"><strong>Unit:</strong><br>${j.unitNo || '-'}</div><div class="col-6"><strong>Date:</strong><br>${j.date}</div><div class="col-6"><strong>Foreman:</strong><br>${j.foreman}</div><div class="col-6"><strong>Tel:</strong><br>${j.tel}</div></div> ${mapHTML}`;
    const area = document.getElementById('actionArea');
    if(j.emailStatus) area.innerHTML = `<div class="alert alert-success py-1 text-center mt-2 small">RECEIVED</div>`;
    else area.innerHTML = `<button class="btn btn-success btn-sm w-100 mt-2" onclick="confirmDocs()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>`;
    const btns = document.getElementById('manageButtons');
    btns.innerHTML = (currentUser && (currentUser.role === 'Admin' || currentUser.username === j.createdBy)) ? `<button class="btn btn-outline-danger btn-sm me-1 py-0" onclick="deleteJob()">Delete</button><button class="btn btn-dark btn-sm py-0" onclick="switchToEdit()">Edit</button>` : "";
    new bootstrap.Modal(document.getElementById('detailModal')).show();
  }

  async function submitBooking() {
    const form = document.getElementById('bookingForm'); if(!form.checkValidity()) { form.classList.add('was-validated'); return; }
    const formData = { rowId: document.getElementById('formRowId').value, site: document.getElementById('site').value, equipNo: document.getElementById('equipNo').value, unitNo: document.getElementById('unitNo').value, date: document.getElementById('date').value, type: document.getElementById('type').value, inspectorName: document.getElementById('inspectorName').value, foreman: document.getElementById('foreman').value, tel: document.getElementById('tel').value, map: document.getElementById('map').value };
    showLoading(true); const res = await callAPI(formData.rowId ? 'updateBooking' : 'saveBooking', formData); showLoading(false);
    if(res.success) { Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", res.message, "success"); bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide(); loadData(); } else Swal.fire("Error", res.message, "error");
  }

  function handleLogout() { currentUser = null; updateUI(); Swal.fire("Logged out", "", "info"); }
  async function confirmDocs() { if(!currentUser) return openLoginModal(); showLoading(true); await callAPI('confirmDocs', { rowId: currentJobId }); showLoading(false); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); loadData(); }
  async function deleteJob() { if(!confirm("Delete?")) return; showLoading(true); await callAPI('deleteBooking', { rowId: currentJobId }); showLoading(false); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); loadData(); }
  function switchToEdit() { const j = allJobs.find(x => x.rowId === currentJobId); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); document.getElementById('formRowId').value = j.rowId; document.getElementById('site').value = j.site; document.getElementById('equipNo').value = j.equipNo; document.getElementById('unitNo').value = j.unitNo; document.getElementById('date').value = j.date; document.getElementById('foreman').value = j.foreman; document.getElementById('tel').value = j.tel; document.getElementById('map').value = j.map; new bootstrap.Modal(document.getElementById('bookingModal')).show(); }
  function toggleAuthView(v) { document.getElementById('viewLogin').style.display=v==='login'?'block':'none'; document.getElementById('viewRegister').style.display=v==='register'?'block':'none'; }
  function openLoginModal() { new bootstrap.Modal(document.getElementById('authModal')).show(); toggleAuthView('login'); }
  function openMenuModal() { new bootstrap.Modal(document.getElementById('menuModal')).show(); }
  function openManualModal() { new bootstrap.Modal(document.getElementById('manualModal')).show(); }
  function openBookingModal() { bootstrap.Modal.getOrCreateInstance(document.getElementById('menuModal')).hide(); document.getElementById('bookingForm').reset(); document.getElementById('formRowId').value=""; new bootstrap.Modal(document.getElementById('bookingModal')).show(); }
  function validateDate(i) { const d=new Date(i.value),t=new Date(); d.setHours(0,0,0,0); t.setHours(0,0,0,0); const diff=(d-t)/864e5; i.setCustomValidity((diff<3||diff>60)?'Invalid':''); }
  function showLoading(s, m) { document.getElementById('globalLoading').style.display=s?'flex':'none'; if(m) document.getElementById('loadingText').innerText=m; }
  async function openHistoryModal() { const res = await callAPI('getLogs'); if(res.success) document.getElementById('historyBody').innerHTML = res.logs.map(l => `<tr style="font-size:10px;"><td>${l.time}</td><td>${l.user}</td><td>${l.action}</td><td>${l.detail}</td></tr>`).join(''); new bootstrap.Modal(document.getElementById('historyModal')).show(); }
</script>
</body>
</html>

